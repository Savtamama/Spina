window.Spina = {}

Trix.config.blockAttributes = $.extend Trix.config.blockAttributes, {
  heading2:
    tagName: "h2"
    terminal: true
    breakOnReturn: true
    group: false
  heading3:
    tagName: "h3"
    terminal: true
    breakOnReturn: true
    group: false
  heading4:
    tagName: "h4"
    terminal: true
    breakOnReturn: true
    group: false
  heading5:
    tagName: "h5"
    terminal: true
    breakOnReturn: true
    group: false
  heading6:
    tagName: "h6"
    terminal: true
    breakOnReturn: true
    group: false    
}

Trix.config.textAttributes = $.extend Trix.config.textAttributes, {
  textAlignJustify:
    style: { "textAlign": "justify", display: "block" }
    parser: (element) ->
      element.style.textAlign == "justify"
    inheritable: true
  textAlignCenter:
    style: { "textAlign": "center", display: "block" }
    parser: (element) ->
      element.style.textAlign == "center"
    inheritable: true
  textAlignLeft:
    style: { "textAlign": "left", display: "block" }
    parser: (element) ->
      element.style.textAlign == "left"
    inheritable: true
  textAlignRight:
    style: { "textAlign": "right", display: "block" }
    parser: (element) ->
      element.style.textAlign == "right"
    inheritable: true
}

Trix.config.lang = $.extend Trix.config.lang, {
  image: "Image"
  heading1: "H1"
  heading2: "H2"
  heading3: "H3"
  heading4: "H4"
  heading5: "H5"
  heading6: "H6"
  text_justify: "Text Align Justify"
  text_left: "Text Align Left"
  text_right: "Text Align Right"
}

Trix.config.toolbar =
  getDefaultHTML: -> """
    <div class="trix-button-row">
      <span class="trix-button-group trix-button-group--text-tools" data-trix-button-group="text-tools">
        <button type="button" class="trix-button trix-button--icon trix-button--icon-bold" data-trix-attribute="bold" data-trix-key="b" title="#{Trix.config.lang.bold}" tabindex="-1">#{Trix.config.lang.bold}</button>
        <button type="button" class="trix-button trix-button--icon trix-button--icon-italic" data-trix-attribute="italic" data-trix-key="i" title="#{Trix.config.lang.italic}" tabindex="-1">#{Trix.config.lang.italic}</button>
        <button type="button" class="trix-button trix-button--icon trix-button--icon-strike" data-trix-attribute="strike" title="#{Trix.config.lang.strike}" tabindex="-1">#{Trix.config.lang.strike}</button>
        <button type="button" class="trix-button trix-button--icon trix-button--icon-link" data-trix-attribute="href" data-trix-action="link" data-trix-key="k" title="#{Trix.config.lang.link}" tabindex="-1">#{Trix.config.lang.link}</button>
      </span>
      <span class="trix-button-group trix-button-group--block-tools" data-trix-button-group="block-tools">
        <button type="button" class="trix-button trix-button--text" data-trix-attribute="heading1" title="#{Trix.config.lang.heading1}" tabindex="-1">#{Trix.config.lang.heading1}</button>
        <button type="button" class="trix-button trix-button--text" data-trix-attribute="heading2" title="#{Trix.config.lang.heading2}" tabindex="-1">#{Trix.config.lang.heading2}</button>
        <button type="button" class="trix-button trix-button--text" data-trix-attribute="heading3" title="#{Trix.config.lang.heading3}" tabindex="-1">#{Trix.config.lang.heading3}</button>
        <button type="button" class="trix-button trix-button--text" data-trix-attribute="heading4" title="#{Trix.config.lang.heading4}" tabindex="-1">#{Trix.config.lang.heading4}</button>
        <button type="button" class="trix-button trix-button--text" data-trix-attribute="heading5" title="#{Trix.config.lang.heading5}" tabindex="-1">#{Trix.config.lang.heading5}</button>
        <button type="button" class="trix-button trix-button--text" data-trix-attribute="heading6" title="#{Trix.config.lang.heading6}" tabindex="-1">#{Trix.config.lang.heading6}</button>
      </span>
      <span class="trix-button-group-spacer"></span>
      <span class="trix-button-group trix-button-group--history-tools" data-trix-button-group="history-tools">
        <button type="button" class="trix-button trix-button--icon trix-button--icon-undo" data-trix-action="undo" data-trix-key="z" title="#{Trix.config.lang.undo}" tabindex="-1">#{Trix.config.lang.undo}</button>
        <button type="button" class="trix-button trix-button--icon trix-button--icon-redo" data-trix-action="redo" data-trix-key="shift+z" title="#{Trix.config.lang.redo}" tabindex="-1">#{Trix.config.lang.redo}</button>
      </span>
    </div>
    <div class="trix-button-row">
      <span class="trix-button-group trix-button-group--block-tools" data-trix-button-group="block-tools">
        <button type="button" class="trix-button trix-button--icon trix-button--icon-image" data-trix-attribute="image" data-trix-action="image" title="#{Trix.config.lang.image}" tabindex="-1">#{Trix.config.lang.image}</button>
        <button type="button" class="trix-button trix-button--icon trix-button--icon-quote" data-trix-attribute="quote" title="#{Trix.config.lang.quote}" tabindex="-1">#{Trix.config.lang.quote}</button>
        <button type="button" class="trix-button trix-button--icon trix-button--icon-code" data-trix-attribute="code" title="#{Trix.config.lang.code}" tabindex="-1">#{Trix.config.lang.code}</button>
        <button type="button" class="trix-button trix-button--icon trix-button--icon-bullet-list" data-trix-attribute="bullet" title="#{Trix.config.lang.bullets}" tabindex="-1">#{Trix.config.lang.bullets}</button>
        <button type="button" class="trix-button trix-button--icon trix-button--icon-number-list" data-trix-attribute="number" title="#{Trix.config.lang.numbers}" tabindex="-1">#{Trix.config.lang.numbers}</button>
        <button type="button" class="trix-button trix-button--icon trix-button--icon-decrease-nesting-level" data-trix-action="decreaseNestingLevel" title="#{Trix.config.lang.outdent}" tabindex="-1">#{Trix.config.lang.outdent}</button>
        <button type="button" class="trix-button trix-button--icon trix-button--icon-increase-nesting-level" data-trix-action="increaseNestingLevel" title="#{Trix.config.lang.indent}" tabindex="-1">#{Trix.config.lang.indent}</button>
        <button type="button" class="trix-button trix-button--text" data-trix-attribute="textAlignLeft" title="#{Trix.config.lang.text_left}" tabindex="-1"><span class="fas fa-align-left"></span></button>
        <button type="button" class="trix-button trix-button--text" data-trix-attribute="textAlignCenter" title="#{Trix.config.lang.text_center}" tabindex="-1"><span class="fas fa-align-center"></span></button>
        <button type="button" class="trix-button trix-button--text" data-trix-attribute="textAlignJustify" title="#{Trix.config.lang.text_justify}" tabindex="-1"><span class="fas fa-align-justify"></span></button>
        <button type="button" class="trix-button trix-button--text" data-trix-attribute="textAlignRight" title="#{Trix.config.lang.text_right}" tabindex="-1"><span class="fas fa-align-right"></span></button>        
      </span>
    </div>
    <div class="trix-dialogs" data-trix-dialogs>
      <div class="trix-dialog trix-dialog--link" data-trix-dialog="href" data-trix-dialog-attribute="href">
        <div class="trix-dialog__link-fields">
          <input type="text" name="href" class="trix-input trix-input--dialog" placeholder="#{Trix.config.lang.urlPlaceholder}" aria-label="#{Trix.config.lang.url}" required data-trix-input>
          <div class="trix-button-group">
            <input type="button" class="trix-button trix-button--dialog" value="#{Trix.config.lang.link}" data-trix-method="setAttribute">
            <input type="button" class="trix-button trix-button--dialog" value="#{Trix.config.lang.unlink}" data-trix-method="removeAttribute">
          </div>
        </div>
        <div data-behavior="embed_container">
          <div class="link_to_embed link_to_embed--new">
            Would you like to embed media from this site?
            <input class="btn btn-tertiary outline btn-small ml-3" type="button" data-behavior="embed_url" value="Yes, embed it">
          </div>
        </div>        
      </div>
    </div>
  """

class Spina.TrixAttachment
  @imageSelect: (e) ->
    toolbar_id = $(this).closest('trix-toolbar').attr('id')
    $.get("<%= Spina::Engine.routes.url_helpers.admin_media_picker_path %>" + "?trix_toolbar_id=#{toolbar_id}")

  @imageInsert: (e, url, alt = "", link_to_url = "") ->
    labels = []
    labels.push "‚úçÔ∏è #{alt}" if alt != ""
    labels.push "üîó #{link_to_url}" if link_to_url != ""
    label = labels.join("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;")

    if link_to_url != ""
      attachment = new Trix.Attachment({content: "<a href='#{link_to_url}' class='trix-attachment-spina-image' data-label='#{label}'>
        <img src='#{url}' alt='#{alt}' />
      </a>"})
    else
      attachment = new Trix.Attachment({content: "<span class='trix-attachment-spina-image' data-label='#{label}'>
        <img src='#{url}' alt='#{alt}' />
      </span>"})

    this.editor.insertAttachment(attachment)

class EmbedController
  constructor = (element) ->
    @pattern = /^https:\/\/([^\.]+\.)?youtube\.com\/watch\?v=(.*)/
    @element = element
    @editor = element.editor
    @toolbar = element.toolbarElement
    @hrefElement = @toolbar.querySelector('[data-trix-input][name=\'href\']')
    @embedContainerElement = @toolbar.querySelector('[data-behavior=\'embed_container\']')
    @embedElement = @toolbar.querySelector('[data-behavior=\'embed_url\']')
    @reset()
    @installEventHandlers()
    return

  installEventHandlers = ->
    @hrefElement.addEventListener 'input', @didInput.bind(this)
    @hrefElement.addEventListener 'focusin', @didInput.bind(this)
    @embedElement.addEventListener 'click', @embed.bind(this)
    return

  didInput = (event) ->
    value = event.target.value.trim()
    matches = value.match(@pattern)
    console.log value, matches
    # When patterns are loaded, we can just fetch the embed code
    if `matches != null`
      @fetch matches[2]
      # No embed code, just reset the form
    else
      @reset()
    return

  fetch = (value) ->
    Rails.ajax
      url: '/youtube/' + encodeURIComponent(value)
      type: 'get'
      error: @reset.bind(this)
      success: @showEmbed.bind(this)
    return

  embed = (event) ->
    if `this.currentEmbed == null`
      return
    attachment = new (Trix.Attachment)(@currentEmbed)
    @editor.insertAttachment attachment
    @element.focus()
    return

  showEmbed = (embed) ->
    @currentEmbed = embed
    @embedContainerElement.style.display = 'block'
    return

  reset = ->
    @embedContainerElement.style.display = 'none'
    @currentEmbed = null
    return     

document.addEventListener 'trix-file-accept', (e) ->
  e.preventDefault()

document.addEventListener 'trix-initialize', (event) ->
  new EmbedController(event.target)
  return

$(document).on 'click', '[data-trix-attribute="image"]', Spina.TrixAttachment.imageSelect

$(document).on 'image-insert', 'trix-editor', Spina.TrixAttachment.imageInsert

$(document).on 'click', 'a.trix-attachment-spina-image', (e) ->
  e.preventDefault() 